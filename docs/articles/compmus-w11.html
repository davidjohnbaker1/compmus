<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Week 11 · Classification • compmus</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Week 11 · Classification">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">compmus</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9003</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/compmus-w08.html">Week 8 · Chroma Features</a>
    </li>
    <li>
      <a href="../articles/compmus-w09.html">Week 9 · Structure Analysis · Self-Similarity Matrices</a>
    </li>
    <li>
      <a href="../articles/compmus-w10.html">Week 10 · Key and Chord Estimation</a>
    </li>
    <li>
      <a href="../articles/compmus-w11.html">Week 11 · Classification</a>
    </li>
    <li>
      <a href="../articles/compmus-w12.html">Week 12 · Similarity and Clustering</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Week 11 · Classification</h1>
                        <h4 class="author">John Ashley Burgoyne</h4>
            
            <h4 class="date">13 March 2019</h4>
      
      
      <div class="hidden name"><code>compmus-w11.Rmd</code></div>

    </div>

    
    
<div id="set-up" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up" class="anchor"></a>Set-up</h2>
<p>Be sure to update your installation of compmus before running this vignette.</p>
<p>We will be using the developing <code>tidymodels</code> framework for integrating with the different machine-learning libraries in a consistent manner.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a></code></pre></div>
<pre><code>## ── Attaching packages ─────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.1.0       ✔ purrr   0.3.2  
## ✔ tibble  2.1.1       ✔ dplyr   0.8.0.1
## ✔ tidyr   0.8.3       ✔ stringr 1.4.0  
## ✔ readr   1.3.1       ✔ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidymodels)</a></code></pre></div>
<pre><code>## ── Attaching packages ────────────────────────────────────────────────────────────────────────────────────── tidymodels 0.0.2 ──</code></pre>
<pre><code>## ✔ broom     0.5.1     ✔ recipes   0.1.4
## ✔ dials     0.0.2     ✔ rsample   0.0.4
## ✔ infer     0.4.0     ✔ yardstick 0.0.3
## ✔ parsnip   0.0.1</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────────────────────────────────────────────────────────── tidymodels_conflicts() ──
## ✖ scales::discard() masks purrr::discard()
## ✖ dplyr::filter()   masks stats::filter()
## ✖ recipes::fixed()  masks stringr::fixed()
## ✖ dplyr::lag()      masks stats::lag()
## ✖ yardstick::spec() masks readr::spec()
## ✖ recipes::step()   masks stats::step()</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(spotifyr)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(compmus)</a></code></pre></div>
<pre><code>## 
## Attaching package: 'compmus'</code></pre>
<pre><code>## The following object is masked from 'package:spotifyr':
## 
##     get_playlist_audio_features</code></pre>
<p>In order for the code below to run, it is also necessary to set up Spotify login credentials for <code>spotifyr</code>.</p>
</div>
<div id="novelty-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#novelty-functions" class="anchor"></a>Novelty Functions</h2>
<p>For novelty functions, we want to work directly with the segments, and not summarise them at higher levels like Spotify’s own estimates of bar or beat.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">pata_pata &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="st">    </span><span class="kw"><a href="../reference/get_tidy_audio_analysis.html">get_tidy_audio_analysis</a></span>(<span class="st">'3uy90vHHATPjtdilshDQDt'</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="st">    </span><span class="kw">select</span>(segments) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(segments)</a></code></pre></div>
<p>We can compute an energy-based novelty function based on Spotify’s loudness estimates. The tempo of this piece is about 126 BPM: how well does this technique work?</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">pata_pata <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">loudness_max_time =</span> start <span class="op">+</span><span class="st"> </span>loudness_max_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="st">    </span><span class="kw">arrange</span>(loudness_max_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">delta_loudness =</span> loudness_max <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lag">lag</a></span>(loudness_max)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> loudness_max_time, <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmax</a></span>(<span class="dv">0</span>, delta_loudness))) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="st">    </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot.window">xlim</a></span>(<span class="dv">0</span>, <span class="dv">30</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="st">    </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Time (s)'</span>, <span class="dt">y =</span> <span class="st">'Novelty'</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 576 rows containing missing values (geom_path).</code></pre>
<p><img src="compmus-w11_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>Because Spotify’s segments are unevenly spaced in time, there is no straightforward way to convert this representation into a tempogram.</p>
<p>We can use similar approaches for chromagrams and cepstrograms. In the case of chromagrams, Aitchison’s clr transformation gives more sensible differences between time points. Even with these helpful transformations, however, self-similarity matrices tend to be more helpful visualisations of chroma and timbre from the Spotify API.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">pata_pata <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pitches =</span> <span class="kw">map</span>(pitches, compmus_normalise, <span class="st">'clr'</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="st">    </span><span class="kw">arrange</span>(start) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pitches =</span> <span class="kw">map2</span>(pitches, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lag">lag</a></span>(pitches), <span class="st">`</span><span class="dt">-</span><span class="st">`</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="st">    </span>compmus_gather_chroma <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="st">    </span><span class="kw">ggplot</span>(</a>
<a class="sourceLine" id="cb15-7" title="7">        <span class="kw">aes</span>(</a>
<a class="sourceLine" id="cb15-8" title="8">            <span class="dt">x =</span> start <span class="op">+</span><span class="st"> </span>duration <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, </a>
<a class="sourceLine" id="cb15-9" title="9">            <span class="dt">width =</span> duration, </a>
<a class="sourceLine" id="cb15-10" title="10">            <span class="dt">y =</span> pitch_class, </a>
<a class="sourceLine" id="cb15-11" title="11">            <span class="dt">fill =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmax</a></span>(<span class="dv">0</span>, value))) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="st">    </span><span class="kw">geom_tile</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb15-13" title="13"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">'E'</span>, <span class="dt">guide =</span> <span class="st">'none'</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-14" title="14"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot.window">xlim</a></span>(<span class="dv">0</span>, <span class="dv">30</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-15" title="15"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Time (s)'</span>, <span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">fill =</span> <span class="st">'Magnitude'</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-16" title="16"><span class="st">    </span><span class="kw">theme_classic</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 6900 rows containing missing values (geom_tile).</code></pre>
<p><img src="compmus-w11_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">pata_pata <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="st">    </span><span class="kw">arrange</span>(start) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">timbre =</span> <span class="kw">map2</span>(timbre, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lag">lag</a></span>(timbre), <span class="st">`</span><span class="dt">-</span><span class="st">`</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">    </span>compmus_gather_timbre <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="st">    </span><span class="kw">ggplot</span>(</a>
<a class="sourceLine" id="cb17-6" title="6">        <span class="kw">aes</span>(</a>
<a class="sourceLine" id="cb17-7" title="7">            <span class="dt">x =</span> start <span class="op">+</span><span class="st"> </span>duration <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, </a>
<a class="sourceLine" id="cb17-8" title="8">            <span class="dt">width =</span> duration, </a>
<a class="sourceLine" id="cb17-9" title="9">            <span class="dt">y =</span> basis, </a>
<a class="sourceLine" id="cb17-10" title="10">            <span class="dt">fill =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmax</a></span>(<span class="dv">0</span>, value))) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-11" title="11"><span class="st">    </span><span class="kw">geom_tile</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-12" title="12"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">'E'</span>, <span class="dt">guide =</span> <span class="st">'none'</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot.window">xlim</a></span>(<span class="dv">0</span>, <span class="dv">30</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-14" title="14"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Time (s)'</span>, <span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">fill =</span> <span class="st">'Magnitude'</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-15" title="15"><span class="st">    </span><span class="kw">theme_classic</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 6900 rows containing missing values (geom_tile).</code></pre>
<p><img src="compmus-w11_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Find a Spotify track that has a regular tempo but lacks percussion (e.g., much Western classical music), and compute the above three representations. How do they differ from what you see for ‘Pata Pata’?</p>
</div>
<div id="classification" class="section level2">
<h2 class="hasAnchor">
<a href="#classification" class="anchor"></a>Classification</h2>
<p>In order to demonstrate some of the principles of classification, we will try to identify some of the features that Spotify uses to designate playlists as ‘workout’ playlists. For a full analysis, we would need to delve deeper, but let’s start with a comparison of three playlists: Indie Pop, Indie Party, and Indie Workout. For speed, this example will work with only the first 20 songs from each playlist, but you should feel free to use more if your computer can handle it.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">pop &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="st">    </span><span class="kw"><a href="../reference/get_playlist_audio_features.html">get_playlist_audio_features</a></span>(<span class="st">'spotify'</span>, <span class="st">'37i9dQZF1DWWEcRhUVtL8n'</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="st">    </span>add_audio_analysis</a>
<a class="sourceLine" id="cb19-5" title="5">party &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="st">    </span><span class="kw"><a href="../reference/get_playlist_audio_features.html">get_playlist_audio_features</a></span>(<span class="st">'spotify'</span>, <span class="st">'37i9dQZF1DWTujiC7wfofZ'</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="st">    </span>add_audio_analysis</a>
<a class="sourceLine" id="cb19-9" title="9">workout &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb19-10" title="10"><span class="st">    </span><span class="kw"><a href="../reference/get_playlist_audio_features.html">get_playlist_audio_features</a></span>(<span class="st">'spotify'</span>, <span class="st">'37i9dQZF1DXaRL7xbcDl7X'</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="st">    </span>add_audio_analysis</a></code></pre></div>
<p>As you think about this lab session – and your portfolio – think about the four kinds of validity that Sturm and Wiggins discussed in our reading for this week. Do these projects have:</p>
<ul>
<li>Statistical validity [somewhat beyond the scope of this course]?</li>
<li>Content validity?</li>
<li>Internal validity?</li>
<li>External validity?</li>
</ul>
<p>We bind the three playlists together using the trick from Week 7, transpose the chroma vectors to a common tonic using the <code>compmus_c_transpose</code> function, and then summarise the vectors like we did when generating chromagrams and cepstrograms. Again, Aitchison’s clr transformation can help with chroma.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">indie &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="st">    </span>pop <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">playlist =</span> <span class="st">"Indie Pop"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="st">    </span><span class="kw">bind_rows</span>(</a>
<a class="sourceLine" id="cb20-4" title="4">        party <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">playlist =</span> <span class="st">"Indie Party"</span>),</a>
<a class="sourceLine" id="cb20-5" title="5">        workout <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">playlist =</span> <span class="st">"Indie Workout"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-6" title="6"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">playlist =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(playlist)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb20-8" title="8">        <span class="dt">segments =</span> </a>
<a class="sourceLine" id="cb20-9" title="9">            <span class="kw">map2</span>(segments, key, compmus_c_transpose)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb20-11" title="11">        <span class="dt">pitches =</span> </a>
<a class="sourceLine" id="cb20-12" title="12">            <span class="kw">map</span>(segments, </a>
<a class="sourceLine" id="cb20-13" title="13">                compmus_summarise, pitches, </a>
<a class="sourceLine" id="cb20-14" title="14">                <span class="dt">method =</span> <span class="st">'mean'</span>, <span class="dt">norm =</span> <span class="st">'manhattan'</span>),</a>
<a class="sourceLine" id="cb20-15" title="15">        <span class="dt">timbre =</span></a>
<a class="sourceLine" id="cb20-16" title="16">            <span class="kw">map</span>(</a>
<a class="sourceLine" id="cb20-17" title="17">                segments,</a>
<a class="sourceLine" id="cb20-18" title="18">                compmus_summarise, timbre,</a>
<a class="sourceLine" id="cb20-19" title="19">                <span class="dt">method =</span> <span class="st">'mean'</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-20" title="20"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pitches =</span> <span class="kw">map</span>(pitches, compmus_normalise, <span class="st">'clr'</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-21" title="21"><span class="st">    </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(pitches, timbre), map, bind_rows) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-22" title="22"><span class="st">    </span><span class="kw">unnest</span>(pitches, timbre)</a></code></pre></div>
<div id="pre-processing" class="section level3">
<h3 class="hasAnchor">
<a href="#pre-processing" class="anchor"></a>Pre-processing</h3>
<p>In the <code>tidyverse</code> approach, we can preprocess data with a <code>recipe</code> specifying what we are predicting and what variables we think might be useful for that prediction. Then we use <code>step</code> functions to do any data clean (usually centering and scaling, but <code>step_range</code> is a viable alternative that squeezes everything to be between 0 and 1). Finally we <code>prep</code> and <code>juice</code> the data.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">indie_class &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="st">    </span><span class="kw">recipe</span>(playlist <span class="op">~</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="st">               </span>danceability <span class="op">+</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="st">               </span>energy <span class="op">+</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="st">               </span>loudness <span class="op">+</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="st">               </span>speechiness <span class="op">+</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="st">               </span>acousticness <span class="op">+</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="st">               </span>instrumentalness <span class="op">+</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="st">               </span>liveness <span class="op">+</span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="st">               </span>valence <span class="op">+</span></a>
<a class="sourceLine" id="cb21-11" title="11"><span class="st">               </span>tempo <span class="op">+</span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="st">               </span>duration_ms <span class="op">+</span></a>
<a class="sourceLine" id="cb21-13" title="13"><span class="st">               </span>C <span class="op">+</span><span class="st"> `</span><span class="dt">C#|Db</span><span class="st">`</span> <span class="op">+</span><span class="st"> </span>D <span class="op">+</span><span class="st"> `</span><span class="dt">D#|Eb</span><span class="st">`</span> <span class="op">+</span></a>
<a class="sourceLine" id="cb21-14" title="14"><span class="st">               </span>E <span class="op">+</span><span class="st"> `</span><span class="dt">F</span><span class="st">`</span> <span class="op">+</span><span class="st"> `</span><span class="dt">F#|Gb</span><span class="st">`</span> <span class="op">+</span><span class="st"> </span>G <span class="op">+</span></a>
<a class="sourceLine" id="cb21-15" title="15"><span class="st">               `</span><span class="dt">G#|Ab</span><span class="st">`</span> <span class="op">+</span><span class="st"> </span>A <span class="op">+</span><span class="st"> `</span><span class="dt">A#|Bb</span><span class="st">`</span> <span class="op">+</span><span class="st"> </span>B <span class="op">+</span></a>
<a class="sourceLine" id="cb21-16" title="16"><span class="st">               </span>c01 <span class="op">+</span><span class="st"> </span>c02 <span class="op">+</span><span class="st"> </span>c03 <span class="op">+</span><span class="st"> </span>c04 <span class="op">+</span><span class="st"> </span>c05 <span class="op">+</span><span class="st"> </span>c06 <span class="op">+</span></a>
<a class="sourceLine" id="cb21-17" title="17"><span class="st">               </span>c07 <span class="op">+</span><span class="st"> </span>c08 <span class="op">+</span><span class="st"> </span>c09 <span class="op">+</span><span class="st"> </span>c10 <span class="op">+</span><span class="st"> </span>c11 <span class="op">+</span><span class="st"> </span>c12,</a>
<a class="sourceLine" id="cb21-18" title="18">           <span class="dt">data =</span> indie) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-19" title="19"><span class="st">    </span><span class="kw">step_center</span>(<span class="kw">all_predictors</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-20" title="20"><span class="st">    </span><span class="kw">step_scale</span>(<span class="kw">all_predictors</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-21" title="21"><span class="st">    </span><span class="co"># step_range(all_predictors()) %&gt;% </span></a>
<a class="sourceLine" id="cb21-22" title="22"><span class="st">    </span><span class="kw">prep</span>(indie) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-23" title="23"><span class="st">    </span>juice</a></code></pre></div>
</div>
<div id="cross-validation" class="section level3">
<h3 class="hasAnchor">
<a href="#cross-validation" class="anchor"></a>Cross-Validation</h3>
<p>The <code>vfold_cv</code> function sets up cross-validation. We will use 5-fold cross-validation here in the interest of spped, but 10-fold cross-validation is more typical.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">indie_cv &lt;-<span class="st"> </span>indie_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">vfold_cv</span>(<span class="dv">5</span>)</a></code></pre></div>
</div>
<div id="classification-algorithms" class="section level3">
<h3 class="hasAnchor">
<a href="#classification-algorithms" class="anchor"></a>Classification Algorithms</h3>
<p>Your DataCamp tutorials this week introduced four classical algorithms for classification: <span class="math inline">\(k\)</span>-nearest neighbour, naive Bayes, logistic regression, and decision trees. Other than naive Bayes, all of them can be implemented more simply in <code>tidymodels</code>. In order to use cross-validation, however, we need to write some local helper functions to <code>fit</code> the classifier on the training sets, <code>predict</code> the labels for the test/validation sets, and <code>bind</code> the results to the original data.</p>
<div id="k-nearest-neighbour" class="section level4">
<h4 class="hasAnchor">
<a href="#k-nearest-neighbour" class="anchor"></a><span class="math inline">\(k\)</span>-Nearest Neighbour</h4>
<p>A <span class="math inline">\(k\)</span>-nearest neighbour classifier often works just fine with only one neighbour. It is very sensitive to the choice of features, however. Let’s check the performance as a baseline and come back to it later.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">indie_knn &lt;-<span class="st"> </span><span class="kw">nearest_neighbor</span>(<span class="dt">neighbors =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_engine</span>(<span class="st">'kknn'</span>)</a>
<a class="sourceLine" id="cb23-2" title="2">predict_knn &lt;-<span class="st"> </span><span class="cf">function</span>(split)</a>
<a class="sourceLine" id="cb23-3" title="3">    <span class="kw">fit</span>(indie_knn, playlist <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> <span class="kw">analysis</span>(split)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(<span class="kw">assessment</span>(split), <span class="dt">type =</span> <span class="st">'class'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="st">    </span><span class="kw">bind_cols</span>(<span class="kw">assessment</span>(split))</a></code></pre></div>
<p>After a little awkwardness with cross-validation, we can use <code>conf_mat</code> to get a confusion matrix.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_knn)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="st">    </span><span class="kw">conf_mat</span>(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class)</a></code></pre></div>
<pre><code>##                Truth
## Prediction      Indie Party Indie Pop Indie Workout
##   Indie Party            13         5             7
##   Indie Pop               3        10             9
##   Indie Workout           4         5             4</code></pre>
<p>These matrices <code>autoplot</code> in two forms.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_knn)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="st">    </span><span class="kw">conf_mat</span>(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-4" title="4"><span class="st">    </span><span class="kw">autoplot</span>(<span class="dt">type =</span> <span class="st">'mosaic'</span>)</a></code></pre></div>
<p><img src="compmus-w11_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_knn)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-3" title="3"><span class="st">    </span><span class="kw">conf_mat</span>(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-4" title="4"><span class="st">    </span><span class="kw">autoplot</span>(<span class="dt">type =</span> <span class="st">'heatmap'</span>)</a></code></pre></div>
<p><img src="compmus-w11_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>We can also compute statistics like accuracy, Cohen’s kappa, or the J-measure.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_knn)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="st">    </span><span class="kw">metric_set</span>(accuracy, kap, j_index)(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy multiclass     0.45 
## 2 kap      multiclass     0.175
## 3 j_index  macro          0.175</code></pre>
</div>
<div id="logistic-and-multinomial-regression" class="section level4">
<h4 class="hasAnchor">
<a href="#logistic-and-multinomial-regression" class="anchor"></a>Logistic and Multinomial Regression</h4>
<p>In the two-class case, we use logistic regression, but beware if you have more than two classes! R will just build a classifier for the first two without warning.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1">indie_logistic &lt;-<span class="st"> </span><span class="kw">logistic_reg</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_engine</span>(<span class="st">'glm'</span>)</a>
<a class="sourceLine" id="cb30-2" title="2">predict_logistic &lt;-<span class="st"> </span><span class="cf">function</span>(split)</a>
<a class="sourceLine" id="cb30-3" title="3">    <span class="kw">fit</span>(indie_logistic, playlist <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> <span class="kw">analysis</span>(split)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-4" title="4"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(<span class="kw">assessment</span>(split), <span class="dt">type =</span> <span class="st">'class'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-5" title="5"><span class="st">    </span><span class="kw">bind_cols</span>(<span class="kw">assessment</span>(split))</a></code></pre></div>
<p>With three or more classes, we need multinomial regression instead. You can adjust the penalty parameter if you are feeling adventurous.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">indie_multinom &lt;-<span class="st"> </span><span class="kw">multinom_reg</span>(<span class="dt">penalty =</span> <span class="fl">0.1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_engine</span>(<span class="st">'glmnet'</span>)</a>
<a class="sourceLine" id="cb31-2" title="2">predict_multinom &lt;-<span class="st"> </span><span class="cf">function</span>(split)</a>
<a class="sourceLine" id="cb31-3" title="3">    <span class="kw">fit</span>(indie_multinom, playlist <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> <span class="kw">analysis</span>(split)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-4" title="4"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(<span class="kw">assessment</span>(split), <span class="dt">type =</span> <span class="st">'class'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-5" title="5"><span class="st">    </span><span class="kw">bind_cols</span>(<span class="kw">assessment</span>(split))</a></code></pre></div>
<p>It is not a strong classifier for this problem.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_multinom)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-3" title="3"><span class="st">    </span><span class="kw">metric_set</span>(accuracy, kap, j_index)(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy multiclass     0.467
## 2 kap      multiclass     0.2  
## 3 j_index  macro          0.200</code></pre>
<p>We can look at the most important features in the model by using the <code>coef</code> method.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">indie_class <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="st">    </span><span class="kw">fit</span>(indie_multinom, playlist <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> .) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="st">    </span><span class="kw">pluck</span>(<span class="st">'fit'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-4" title="4"><span class="st">    </span>coef</a></code></pre></div>
<pre><code>## $`Indie Party`
## 35 x 1 sparse Matrix of class "dgCMatrix"
##                           s0
##                  -0.08549468
## danceability      .         
## energy            .         
## loudness          .         
## speechiness       .         
## acousticness      .         
## instrumentalness  .         
## liveness          .         
## valence           .         
## tempo             .         
## duration_ms       .         
## C                 .         
## `C#|Db`           .         
## D                 .         
## `D#|Eb`           .         
## E                 .         
## F                 .         
## `F#|Gb`           .         
## G                 .         
## `G#|Ab`           .         
## A                 .         
## `A#|Bb`           .         
## B                 .         
## c01               0.75145930
## c02               0.04339348
## c03               .         
## c04               .         
## c05               .         
## c06               .         
## c07               .         
## c08               .         
## c09               .         
## c10               .         
## c11               .         
## c12               .         
## 
## $`Indie Pop`
## 35 x 1 sparse Matrix of class "dgCMatrix"
##                           s0
##                   0.02586975
## danceability      .         
## energy           -0.24371024
## loudness          .         
## speechiness       0.22367590
## acousticness      .         
## instrumentalness  .         
## liveness          .         
## valence           .         
## tempo             .         
## duration_ms       .         
## C                 .         
## `C#|Db`           .         
## D                 .         
## `D#|Eb`           .         
## E                 .         
## F                 .         
## `F#|Gb`           .         
## G                 .         
## `G#|Ab`           .         
## A                 .         
## `A#|Bb`           .         
## B                 .         
## c01               .         
## c02               .         
## c03               .         
## c04               .         
## c05               0.12040406
## c06               .         
## c07               .         
## c08               .         
## c09               .         
## c10               .         
## c11               .         
## c12               .         
## 
## $`Indie Workout`
## 35 x 1 sparse Matrix of class "dgCMatrix"
##                           s0
##                   0.05962493
## danceability      .         
## energy            .         
## loudness          .         
## speechiness       .         
## acousticness      .         
## instrumentalness  0.09010643
## liveness         -0.31857013
## valence           .         
## tempo             .         
## duration_ms       .         
## C                 .         
## `C#|Db`           .         
## D                 .         
## `D#|Eb`           .         
## E                 .         
## F                 .         
## `F#|Gb`           .         
## G                 .         
## `G#|Ab`           .         
## A                 .         
## `A#|Bb`           .         
## B                 .         
## c01               .         
## c02               .         
## c03               .         
## c04               .         
## c05               .         
## c06               .         
## c07               .         
## c08              -0.14993267
## c09               .         
## c10               .         
## c11               .         
## c12               .</code></pre>
</div>
<div id="decision-trees" class="section level4">
<h4 class="hasAnchor">
<a href="#decision-trees" class="anchor"></a>Decision Trees</h4>
<p>Decision trees are nicely intuitive, and perform somewhat better here.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1">indie_tree &lt;-<span class="st"> </span><span class="kw">decision_tree</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_engine</span>(<span class="st">'C5.0'</span>)</a>
<a class="sourceLine" id="cb36-2" title="2">predict_tree &lt;-<span class="st"> </span><span class="cf">function</span>(split)</a>
<a class="sourceLine" id="cb36-3" title="3">    <span class="kw">fit</span>(indie_tree, playlist <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> <span class="kw">analysis</span>(split)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb36-4" title="4"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(<span class="kw">assessment</span>(split), <span class="dt">type =</span> <span class="st">'class'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-5" title="5"><span class="st">    </span><span class="kw">bind_cols</span>(<span class="kw">assessment</span>(split))</a></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_tree)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-3" title="3"><span class="st">    </span><span class="kw">metric_set</span>(accuracy, kap, j_index)(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy multiclass     0.533
## 2 kap      multiclass     0.3  
## 3 j_index  macro          0.300</code></pre>
<p>We can look at the whole tree with the <code>summary</code> command. Be careful not to read too much into the actual numerical values, however: remember that the features were standardised before we started classification. Without cross-validation, the algorithm looks much better from the summary than it actually was in practice, but we can still see that timbre features are important and chroma features probably aren’t.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1">indie_class <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-2" title="2"><span class="st">    </span><span class="kw">fit</span>(indie_tree, playlist <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> .) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-3" title="3"><span class="st">    </span><span class="kw">pluck</span>(<span class="st">'fit'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-4" title="4"><span class="st">    </span>summary</a></code></pre></div>
<pre><code>## 
## Call:
## C5.0.default(x = x, y = y, trials = 1, control =
##  C50::C5.0Control(minCases = 2, sample = 0))
## 
## 
## C5.0 [Release 2.07 GPL Edition]      Wed Mar 20 06:52:30 2019
## -------------------------------
## 
## Class specified by attribute `outcome'
## 
## Read 60 cases (35 attributes) from undefined.data
## 
## Decision tree:
## 
## c01 &gt; 0.4132243:
## :...speechiness &gt; -0.41795: Indie Party (14)
## :   speechiness &lt;= -0.41795:
## :   :...c07 &lt;= -0.4102254: Indie Party (3/1)
## :       c07 &gt; -0.4102254: Indie Workout (6)
## c01 &lt;= 0.4132243:
## :...instrumentalness &gt; 2.20822: Indie Workout (3)
##     instrumentalness &lt;= 2.20822:
##     :...c05 &lt;= -0.9133876: Indie Party (3)
##         c05 &gt; -0.9133876:
##         :...c10 &gt; 1.301977: Indie Party (2/1)
##             c10 &lt;= 1.301977:
##             :...c08 &lt;= -2.488703: Indie Workout (2)
##                 c08 &gt; -2.488703:
##                 :...G &gt; 1.162019: Indie Workout (3)
##                     G &lt;= 1.162019:
##                     :...A &gt; 1.233386: Indie Workout (2)
##                         A &lt;= 1.233386:
##                         :...acousticness &lt;= -0.5810226: Indie Workout (3/1)
##                             acousticness &gt; -0.5810226: Indie Pop (19)
## 
## 
## Evaluation on training data (60 cases):
## 
##      Decision Tree   
##    ----------------  
##    Size      Errors  
## 
##      11    3( 5.0%)   &lt;&lt;
## 
## 
##     (a)   (b)   (c)    &lt;-classified as
##    ----  ----  ----
##      20                (a): class Indie Party
##            19     1    (b): class Indie Pop
##       2          18    (c): class Indie Workout
## 
## 
##  Attribute usage:
## 
##  100.00% c01
##   61.67% instrumentalness
##   56.67% c05
##   51.67% c10
##   48.33% c08
##   45.00% G
##   40.00% A
##   38.33% speechiness
##   36.67% acousticness
##   15.00% c07
## 
## 
## Time: 0.0 secs</code></pre>
</div>
<div id="random-forests" class="section level4">
<h4 class="hasAnchor">
<a href="#random-forests" class="anchor"></a>Random Forests</h4>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1">indie_forest &lt;-<span class="st"> </span><span class="kw">rand_forest</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_engine</span>(<span class="st">'randomForest'</span>)</a>
<a class="sourceLine" id="cb41-2" title="2">predict_forest &lt;-<span class="st"> </span><span class="cf">function</span>(split)</a>
<a class="sourceLine" id="cb41-3" title="3">    <span class="kw">fit</span>(indie_forest, playlist <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> <span class="kw">analysis</span>(split)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb41-4" title="4"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(<span class="kw">assessment</span>(split), <span class="dt">type =</span> <span class="st">'class'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-5" title="5"><span class="st">    </span><span class="kw">bind_cols</span>(<span class="kw">assessment</span>(split))</a></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_forest)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-3" title="3"><span class="st">    </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-4" title="4"><span class="st">    </span><span class="kw">metric_set</span>(accuracy, kap, j_index)(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy multiclass     0.533
## 2 kap      multiclass     0.3  
## 3 j_index  macro          0.3</code></pre>
<p>Random forests give us the best-quality ranking of feature importance, and we can plot it with <code><a href="https://www.rdocumentation.org/packages/randomForest/topics/varImpPlot">randomForest::varImpPlot</a></code>. Again, it is clear that timbre, specifically Component 1 (power) and Component 11, is important. Note that because random forests are indeed random, the accuracy and feature rankings will vary (slightly) every time you re-run the code.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1">indie_class <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-2" title="2"><span class="st">    </span><span class="kw">fit</span>(indie_forest, playlist <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> .) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-3" title="3"><span class="st">    </span><span class="kw">pluck</span>(<span class="st">'fit'</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-4" title="4"><span class="st">    </span>randomForest<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/randomForest/topics/varImpPlot">varImpPlot</a></span>()</a></code></pre></div>
<p><img src="compmus-w11_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
</div>
<div id="feature-selection" class="section level4">
<h4 class="hasAnchor">
<a href="#feature-selection" class="anchor"></a>Feature Selection</h4>
<p>Let’s try <span class="math inline">\(k\)</span>-NN again with just the top features. We see much better results.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1">predict_knn_reduced &lt;-<span class="st"> </span><span class="cf">function</span>(split)</a>
<a class="sourceLine" id="cb45-2" title="2">    <span class="kw">fit</span>(</a>
<a class="sourceLine" id="cb45-3" title="3">        indie_knn, </a>
<a class="sourceLine" id="cb45-4" title="4">        playlist <span class="op">~</span><span class="st"> </span>c01 <span class="op">+</span><span class="st"> </span>c11 <span class="op">+</span><span class="st"> </span>liveness <span class="op">+</span><span class="st"> </span>energy <span class="op">+</span><span class="st"> </span>acousticness, </a>
<a class="sourceLine" id="cb45-5" title="5">        <span class="dt">data =</span> <span class="kw">analysis</span>(split)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-6" title="6"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(<span class="kw">assessment</span>(split), <span class="dt">type =</span> <span class="st">'class'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-7" title="7"><span class="st">    </span><span class="kw">bind_cols</span>(<span class="kw">assessment</span>(split))</a>
<a class="sourceLine" id="cb45-8" title="8">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-9" title="9"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_knn_reduced)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-10" title="10"><span class="st">    </span><span class="kw">metric_set</span>(accuracy, kap, j_index)(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy multiclass     0.55 
## 2 kap      multiclass     0.325
## 3 j_index  macro          0.325</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" title="1">indie_cv <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb47-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pred =</span> <span class="kw">map</span>(splits, predict_knn_reduced)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb47-3" title="3"><span class="st">    </span><span class="kw">conf_mat</span>(<span class="dt">truth =</span> playlist, <span class="dt">estimate =</span> .pred_class) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb47-4" title="4"><span class="st">    </span><span class="kw">autoplot</span>(<span class="dt">type =</span> <span class="st">'mosaic'</span>)</a></code></pre></div>
<p><img src="compmus-w11_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>Armed with this feature set, perhaps we can make a better plot. It’s clear that the workout list has fewer live tracks, and that the party playlist is somewhat louder and higher on Component 11 than the pop list.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1">indie <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-2" title="2"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> c01, <span class="dt">y =</span> c11, <span class="dt">colour =</span> playlist, <span class="dt">size =</span> liveness)) <span class="op">+</span></a>
<a class="sourceLine" id="cb48-3" title="3"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.8</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb48-4" title="4"><span class="st">    </span><span class="kw">scale_color_brewer</span>(<span class="dt">type =</span> <span class="st">'qual'</span>, <span class="dt">palette =</span> <span class="st">'Accent'</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb48-5" title="5"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Timbre Component 1'</span>, <span class="dt">y =</span> <span class="st">'Timbre Component 11'</span>, <span class="dt">size =</span> <span class="st">'Liveness'</span>, <span class="dt">colour =</span> <span class="st">'Playlist'</span>)</a></code></pre></div>
<p><img src="compmus-w11_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
</div>
</div>
</div>
<div id="deltas-and-delta-deltas-advanced" class="section level2">
<h2 class="hasAnchor">
<a href="#deltas-and-delta-deltas-advanced" class="anchor"></a>Deltas and Delta-Deltas (Advanced)</h2>
<p>Although the novelty-based transformations of chroma and timbre features are not always useful for visualisations, they can be very useful for classification. Both ‘deltas’ and ‘delta-deltas’, especially for timbre features, are in regular use in music information retrieval. The code example below shows how to compute average <em>delta</em> chroma and timbre features instead of the ordinary average. Can you incorporate it into the classifiers above? Can you add delta-deltas, too?</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" title="1">indie_deltas &lt;-</a>
<a class="sourceLine" id="cb49-2" title="2"><span class="st">    </span>pop <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">playlist =</span> <span class="st">"Indie Pop"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-3" title="3"><span class="st">    </span><span class="kw">bind_rows</span>(</a>
<a class="sourceLine" id="cb49-4" title="4">        party <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">playlist =</span> <span class="st">"Indie Party"</span>),</a>
<a class="sourceLine" id="cb49-5" title="5">        workout <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">playlist =</span> <span class="st">"Indie Workout"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-6" title="6"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">playlist =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(playlist)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-7" title="7"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb49-8" title="8">        <span class="dt">segments =</span> </a>
<a class="sourceLine" id="cb49-9" title="9">            <span class="kw">map2</span>(segments, key, compmus_c_transpose)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-10" title="10"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb49-11" title="11">        <span class="dt">segments =</span> </a>
<a class="sourceLine" id="cb49-12" title="12">            <span class="kw">map</span>(</a>
<a class="sourceLine" id="cb49-13" title="13">                segments, </a>
<a class="sourceLine" id="cb49-14" title="14">                mutate, </a>
<a class="sourceLine" id="cb49-15" title="15">                <span class="dt">pitches =</span> <span class="kw">map</span>(pitches, compmus_normalise, <span class="st">'manhattan'</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-16" title="16"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb49-17" title="17">        <span class="dt">segments =</span></a>
<a class="sourceLine" id="cb49-18" title="18">            <span class="kw">map</span>(</a>
<a class="sourceLine" id="cb49-19" title="19">                segments,</a>
<a class="sourceLine" id="cb49-20" title="20">                mutate,</a>
<a class="sourceLine" id="cb49-21" title="21">                <span class="dt">pitches =</span> <span class="kw">map2</span>(pitches, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lag">lag</a></span>(pitches), <span class="st">`</span><span class="dt">-</span><span class="st">`</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-22" title="22"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb49-23" title="23">        <span class="dt">segments =</span></a>
<a class="sourceLine" id="cb49-24" title="24">            <span class="kw">map</span>(</a>
<a class="sourceLine" id="cb49-25" title="25">                segments,</a>
<a class="sourceLine" id="cb49-26" title="26">                mutate,</a>
<a class="sourceLine" id="cb49-27" title="27">                <span class="dt">timbre =</span> <span class="kw">map2</span>(timbre, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lag">lag</a></span>(timbre), <span class="st">`</span><span class="dt">-</span><span class="st">`</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-28" title="28"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb49-29" title="29">        <span class="dt">pitches =</span></a>
<a class="sourceLine" id="cb49-30" title="30">            <span class="kw">map</span>(segments,</a>
<a class="sourceLine" id="cb49-31" title="31">                compmus_summarise, pitches,</a>
<a class="sourceLine" id="cb49-32" title="32">                <span class="dt">method =</span> <span class="st">'mean'</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb49-33" title="33">        <span class="dt">timbre =</span></a>
<a class="sourceLine" id="cb49-34" title="34">            <span class="kw">map</span>(</a>
<a class="sourceLine" id="cb49-35" title="35">                segments,</a>
<a class="sourceLine" id="cb49-36" title="36">                compmus_summarise, timbre,</a>
<a class="sourceLine" id="cb49-37" title="37">                <span class="dt">method =</span> <span class="st">'mean'</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb49-38" title="38"><span class="st">    </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(pitches, timbre), map, bind_rows) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-39" title="39"><span class="st">    </span><span class="kw">unnest</span>(pitches, timbre)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#set-up">Set-up</a></li>
      <li><a href="#novelty-functions">Novelty Functions</a></li>
      <li><a href="#classification">Classification</a></li>
      <li><a href="#deltas-and-delta-deltas-advanced">Deltas and Delta-Deltas (Advanced)</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Ashley Burgoyne.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
